(window.webpackJsonp=window.webpackJsonp||[]).push([[153],{526:function(t,v,_){"use strict";_.r(v);var i=_(7),e=Object(i.a)({},(function(){var t=this,v=t._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[v("h2",{attrs:{id:"前言"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),v("p",[t._v("TCP 协议是我们每天都在使用的一个网络通讯协议，因为绝大部分的网络连接都是建立在 TCP 协议上的，比如你此刻正在看的这篇文章是建立在 HTTP（Hypertext Transfer Protocol，超文本传送协议） 应用层协议的基础上的，而 HTTP 协议的“底层”则是建立在 TCP 的传输层协议上的。因此可以理解为，你之所以能看到本篇文章就是得益于 TCP 协议的功劳。")]),t._v(" "),v("h2",{attrs:{id:"tcp-三次握手四次挥手的执行流程-以及为什么需要三次握手-四次挥手"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#tcp-三次握手四次挥手的执行流程-以及为什么需要三次握手-四次挥手"}},[t._v("#")]),t._v(" TCP 三次握手四次挥手的执行流程，以及为什么需要三次握手？四次挥手？")]),t._v(" "),v("p",[t._v("在回答这个问题之前，首先我们需要搞清楚两个概念，")]),t._v(" "),v("p",[t._v("第一，什么是 TCP？\n第二，什么是 TCP 连接？")]),t._v(" "),v("p",[t._v("只有搞明白了这两个问题，我们才能彻底搞懂为什么 TCP 需要三次握手？")]),t._v(" "),v("h3",{attrs:{id:"什么是-tcp"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#什么是-tcp"}},[t._v("#")]),t._v(" 什么是 TCP？")]),t._v(" "),v("p",[t._v("首先来说 TCP（Transmission Control Protocol，传输控制协议）是一个面向连接的、可靠的、基于字节流的传输层协议。从它的概念中我们可以看出 TCP 的三个特点：面向连接、可靠性和面向字节流。")]),t._v(" "),v("p",[t._v("TCP 的特点")]),t._v(" "),v("ul",[v("li",[v("p",[t._v("面向连接：是指 TCP 是面向客户端和服务器端连接的通讯协议，使用它可以将客户端和服务器端进行连接。")])]),t._v(" "),v("li",[v("p",[t._v("可靠性：是指无论网络环境多差，TCP 都可以保证信息一定能够传递到接收端。")])])]),t._v(" "),v("p",[t._v("TCP 之所以可以保证可靠性主要得益于两个方面，一个是“状态性”，另一个是“可控制性”。所谓状态性是指 TCP 会记录信息的发送状态，例如，哪些数据收到了、哪些数据没收到等状态信息都会被记录；可控制性是指 TCP 会根据状态情况控制自己的行为，比如当 TCP 意识到丢包了就会控制重发此包，这样就实现了 TCP 的可靠性。")]),t._v(" "),v("ul",[v("li",[t._v("面向字节流：是指 TCP 是以字节流的方式进行数据传输的。")])]),t._v(" "),v("p",[t._v("RFC 793 对 TCP 连接的定义如下：")]),t._v(" "),v("blockquote",[v("p",[t._v("Connections:\nThe reliability and flow control mechanisms described above require that TCPs initialize and maintain certain status information for each data stream.\nThe combination of this information, including sockets, sequence numbers, and window sizes, is called a connection.\n小贴士：TCP 之所以被广泛应用，首先是因为它是一个标准化的协议，TCP 的标准协议就是由 RFC 793 定义的，它已经有了 30 多年的历史，并且已经被多次更新。RFC（Request For Comments）是 IETF（Internet Engineering Task Force）的正式文档。IETF 是一家制定互联网标准的组织，它制定了 Internet（互联网）的整体协议体系，凡是经过 IETF 评审认可的标准都会被发布为带编号的 RFC 的文档。")])]),t._v(" "),v("p",[t._v("TCP 定义的大致意思是，用于保证可靠性和流控制机制的信息，包括 Socket、序列号及窗口大小被称为连接。")]),t._v(" "),v("p",[t._v("其中，Socket 是由 IP 地址加端口号组成的，序列号是用来解决乱序问题的，而窗口大小则是用来做流量控制的。")]),t._v(" "),v("p",[t._v("接下来我们来看 TCP 三次握手的执行流程，如下图所示：")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://fire-repository.oss-cn-beijing.aliyuncs.com/interview/221009/1.png",alt:""}})]),t._v(" "),v("h3",{attrs:{id:"tcp-三次握手的执行流程图"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#tcp-三次握手的执行流程图"}},[t._v("#")]),t._v(" TCP 三次握手的执行流程图")]),t._v(" "),v("p",[t._v("关键字说明：")]),t._v(" "),v("ul",[v("li",[v("p",[t._v("SYN（Synchronize Sequence Numbers），同步序列编号；")])]),t._v(" "),v("li",[v("p",[t._v("ACK（Acknowledge Character），确认字符；")])]),t._v(" "),v("li",[v("p",[t._v("SEQ（Sequence Number），序列号。")])])]),t._v(" "),v("p",[t._v("TCP 的执行流程如下：")]),t._v(" "),v("ol",[v("li",[v("p",[t._v("最开始时客户端和服务端都处于 CLOSED 状态，然后服务端先主动监听某个端口，此时服务器端就变成了 LISTEN（监听）状态；")])]),t._v(" "),v("li",[v("p",[t._v("然后客户端主动发起连接，发送 SYN（同步序列编号），此时客户端就变成了 SYN-SENT 状态；")])]),t._v(" "),v("li",[v("p",[t._v("服务端接收到信息之后返回 SYN 和 ACK 至客户端，此时服务器端就变成了 SYN-REVD 状态；")])]),t._v(" "),v("li",[v("p",[t._v("客户端接收到消息之后，再发送 ACK 至服务器端，此时客户端就变成了 ESTABLISHED（已确认）状态，服务端收到 ACK 之后，也变成了 ESTABLISHED 状态，此时连接工作就执行完了。")])])]),t._v(" "),v("h3",{attrs:{id:"为什么-tcp-需要三次握手"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#为什么-tcp-需要三次握手"}},[t._v("#")]),t._v(" 为什么 TCP 需要三次握手？")]),t._v(" "),v("p",[t._v("了解了以上 TCP 的基础概念之后，我们再来看一下 TCP 为什么需要三次握手？")]),t._v(" "),v("p",[v("strong",[t._v("原因一：防止重复连接")])]),t._v(" "),v("p",[t._v("首先来说 RFC 793 - Transmission Control Protocol 其实就指出了三次握手的主要原因，它的描述如下：")]),t._v(" "),v("blockquote",[v("p",[t._v("The principle reason for the three-way handshake is to prevent old duplicate connection initiations from causing confusion.")])]),t._v(" "),v("p",[t._v("翻译为中文的意思是，三次握手的主要原因是为了防止旧的重复连接引起连接混乱问题。")]),t._v(" "),v("p",[t._v("比如在网络状况比较复杂或者网络状况比较差的情况下，发送方可能会连续发送多次建立连接的请求。如果 TCP 握手的次数只有两次，那么接收方只能选择接受请求或者拒绝接受请求，但它并不清楚这次的请求是正常的请求，还是由于网络环境问题而导致的过期请求，如果是过期请求的话就会造成错误的连接。")]),t._v(" "),v("p",[t._v("所以如果 TCP 是三次握手的话，那么客户端在接收到服务器端 SEQ+1 的消息之后，就可以判断当前的连接是否为历史连接，如果判断为历史连接的话就会发送终止报文（RST）给服务器端终止连接；如果判断当前连接不是历史连接的话就会发送指令给服务器端来建立连接。")]),t._v(" "),v("p",[v("strong",[t._v("原因二：同步初始化序列化")])]),t._v(" "),v("p",[t._v("通过上面的概念我们知道 TCP 的一个重要特征就是可靠性，而 TCP 为了保证在不稳定的网络环境中构建一个稳定的数据连接，它就需要一个“序列号”字段来保证自己的稳定性，而这个序列号的作用就是防止数据包重复发送，以及有效的解决数据包接收时顺序颠倒的问题。")]),t._v(" "),v("p",[t._v("那么在建立 TCP 连接时就需要同步初始化一个序列号来保证 TCP 的稳定性，因此它需要执行以下过程：")]),t._v(" "),v("ol",[v("li",[v("p",[t._v("首先客户端发送一个携带了初始序列号的 SYN 报文给服务器端；")])]),t._v(" "),v("li",[v("p",[t._v("服务端接收到消息之后会回复一个 ACK 的应答报文，表示客户端的 SYN 报文已被服务端成功接收了；")])]),t._v(" "),v("li",[v("p",[t._v("而客户端收到消息之后也会发送一个 ACK 给服务端，服务器端拿到这个消息之后，我们就可以得到一个可靠的初始化序列号了。")])])]),t._v(" "),v("p",[t._v("而如果是两次握手的话，就无法进行序列号的确认工作了，因此也就无法得到一个可靠的序列号了，所以 TCP 连接至少需要三次握手。")]),t._v(" "),v("p",[t._v("以上两种原因就是 TCP 连接为什么需要三次握手的主要原因，当然 TCP 连接还可以四次握手，甚至是五次握手，也能实现 TCP 连接的稳定性，但三次握手是最节省资源的连接方式，因此 TCP 连接应该为三次握手。")]),t._v(" "),v("h3",{attrs:{id:"tcp四次挥手执行流程"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#tcp四次挥手执行流程"}},[t._v("#")]),t._v(" TCP四次挥手执行流程")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://fire-repository.oss-cn-beijing.aliyuncs.com/interview/221009/2.png",alt:""}})]),t._v(" "),v("ul",[v("li",[t._v("客户端-发送一个 FIN，用来关闭客户端到服务器的数据传送，进入FIN_WAIT_1状态")]),t._v(" "),v("li",[t._v("服务器-收到这个 FIN，它发回一 个 ACK，确认序号为收到的序号加 1 。和 SYN 一样，一个 FIN 将占用一个序号，进入CLOSE_WAIT状态")]),t._v(" "),v("li",[t._v("服务器-关闭与客户端的连接，发送一个 FIN 给客户端，进入LAST_ACK状态")]),t._v(" "),v("li",[t._v("客户端-发回 ACK 报文确认，进入TIME_WAIT状态，并将确认序号设置为收到序号加 1，服务端收到后变为CLOSED状态，不再向客户端发送数据。客户端等待2*MSL（报文段最长寿命）时间后，也进入CLOSED状态。完成四次挥手。")])]),t._v(" "),v("h3",{attrs:{id:"为什么-tcp-需要四次挥手"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#为什么-tcp-需要四次挥手"}},[t._v("#")]),t._v(" 为什么 TCP 需要四次挥手？")]),t._v(" "),v("p",[v("strong",[t._v("服务器为什么不能发送ACK和FIN合并起来，变成三次挥手？")])]),t._v(" "),v("p",[t._v("因为服务器收到客户端断开连接的请求时，可能还有一些数据没有发完，这时先回复ACK，表示接收到了断开连接的请求，等到数据发完之后再发送FIN，断开服务器到客户端的数据传送。")]),t._v(" "),v("p",[v("strong",[t._v("如果第二次挥手时服务器的ACK没有送达客户端，会怎么样？")])]),t._v(" "),v("p",[t._v("客户端没有收到ACK确认，会重新发送FIN请求。")]),t._v(" "),v("p",[t._v("第四次挥手时，客户端发送给服务器的ACK有可能丢失，TIME_WAIT状态就是用来重发可能丢失的ACK报文。如果服务端没有收到ACK，就会重发FIN，如果Client在2*MSL的时间内收到了FIN，就会重新发送ACK并再次等待2MSL，防止服务端没有收到ACK而不断重发FIN。")]),t._v(" "),v("blockquote",[v("p",[t._v("注：MSL（Maximum Segment Lifetime），指一个片段在网络中最大的存活时间，2MSL就是一个发送和一个回复所需的最大时间。如果直到2MSL，Client都没有再次收到FIN，那么Client推断ACK已经被成功接收，则结束TCP连接。")])]),t._v(" "),v("h2",{attrs:{id:"知识扩展"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#知识扩展"}},[t._v("#")]),t._v(" 知识扩展")]),t._v(" "),v("p",[t._v("TCP 知识是计算机编程基础，也是面试中常见的面试问题，因为我们现在所使用的大部分连接都是建立在 TCP 基础上的。因此对 TCP 的掌握可以让我们更清楚地理解技术的实现过程，也能帮我们写出更加优秀的代码，以及排查一些和网络相关的问题。除此之外，还有UDP值得我们关注。")]),t._v(" "),v("h3",{attrs:{id:"udp-介绍"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#udp-介绍"}},[t._v("#")]),t._v(" UDP 介绍")]),t._v(" "),v("p",[t._v("UDP（User Data Protocol，用户数据报协议）是无连接的、简单的、面向数据报的传输层协议。也就是 UDP 在发送数据之前，无须建立客户端与服务端的连接，直接发送消息即可。")]),t._v(" "),v("p",[t._v("UDP 的协议头有 8 个字节（64 位），如下图所示：")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://fire-repository.oss-cn-beijing.aliyuncs.com/interview/221009/3.png",alt:""}})]),t._v(" "),v("p",[t._v("其中源端口和目标端口是指记录发送方和接收方端口；UDP 包长度是指 UDP 头部加上 UDP 数据的总长度；UDP 校验和用于效验 UDP 的内容是否可靠。")]),t._v(" "),v("p",[t._v("UDP 常见的使用场景有：语音、视频等多媒体通信、DNS（域名转化）、TFTP 等。")]),t._v(" "),v("h3",{attrs:{id:"tcp-vs-udp"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#tcp-vs-udp"}},[t._v("#")]),t._v(" TCP VS UDP")]),t._v(" "),v("p",[t._v("TCP 和 UDP 的区别主要体现在以下 7 个方面：")]),t._v(" "),v("ul",[v("li",[v("p",[t._v("可靠性，TCP 有“状态性”和“可控制性”可以保证消息不重复、按顺序、不丢失的发送和接收，而 UDP 则不能保证消息的可靠性；")])]),t._v(" "),v("li",[v("p",[t._v("连接，TCP 是面向连接的传输层协议，传输数据前先要建立连接，而 UDP 发送数据之前无需建立连接；")])]),t._v(" "),v("li",[v("p",[t._v("服务对象，TCP 服务的对象为一对一的双端应用，而 UDP 可以应用于一对一、一对多和多对多的通信场景；")])]),t._v(" "),v("li",[v("p",[t._v("效率，TCP 的传输效率较低，而 UDP 的传输效率较高；")])]),t._v(" "),v("li",[v("p",[t._v("流量控制，TCP 有滑动窗口可以用来控制流量，而 UDP 则不具备流量控制的能力；")])]),t._v(" "),v("li",[v("p",[t._v("报文，TCP 是面向字节流的传输层协议，而 UDP 是面向报文的传输层协议；")])]),t._v(" "),v("li",[v("p",[t._v("应用场景，TCP 的应用场景是对消息准确性和顺序要求较高的场景，而 UDP 则是应用于对通信效率较高、准确性要求相对较低的场景。")])])]),t._v(" "),v("p",[t._v("TCP 和 UDP 的使用场景如下图所示：")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://fire-repository.oss-cn-beijing.aliyuncs.com/interview/221009/4.png",alt:""}})]),t._v(" "),v("h2",{attrs:{id:"总结"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),v("p",[t._v("本文讲了TCP 三个特点：面向连接、可靠性和面向字节流，其中可靠性主要是依赖它的状态记录和根据实际情况调整自身的行为方式。例如，当 TCP 意识到丢包时就会重发此包，这样就保证了通信的可靠性。")]),t._v(" "),v("p",[t._v("TCP 之所以需要三次握手的主要原因是为了防止在网络环境比较差的情况下不会进行无效的连接，同时三次握手可以实现 TCP 初始化序列号的确认工作，TCP 需要初始化一个序列号来保证消息的顺序。如果是两次握手则不能确认序列号是否正常，如果是四次握手的话会浪费系统的资源，因此 TCP 三次握手是最优的解决方案，所以 TCP 连接需要三次握手。")]),t._v(" "),v("p",[t._v("最后我们讲了 UDP 的概念，以及 UDP 和 TCP 的区别，在传输效率要求比较高且对可靠性要求不高的情况下可以使用 UDP，反之则应该使用 TCP。")])])}),[],!1,null,null,null);v.default=e.exports}}]);